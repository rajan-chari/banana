# Core Messaging & Chat System Specification

## 1. Feature Overview

The messaging system provides real-time, threaded communication between users through 1:1 direct messages and group chats. It supports rich text formatting, message replies/quotes, @mentions, link previews, reactions, attachments, and read receipts.

### Feature Summary

| Feature | Description |
|---------|-------------|
| 1:1 Chat | Direct messaging between two users |
| Group Chat | Multi-participant conversations (3-250 members) |
| Rich Text | Bold, italic, underline, strikethrough, code, lists, headings |
| Replies/Quotes | Reply to a specific message with quoted context |
| @Mentions | Tag users inline; triggers notification |
| Link Previews | Auto-generated preview cards for shared URLs |
| Reactions | Emoji reactions on messages |
| Attachments | File sharing within chats |
| Read Receipts | Per-message delivery and read status |
| Message Editing | Edit sent messages with "Edited" indicator |
| Message Deletion | Soft-delete with "This message has been deleted" placeholder |
| Typing Indicators | Real-time "X is typing..." display |
| Unread Tracking | Per-chat unread count badges |
| Chat Tabs | Chat, Shared, Recap, Q&A views per conversation |

---

## 2. Data Models

### 2.1 User

```
User {
  id: UUID (PK)
  display_name: string (1-256 chars)
  email: string (unique, indexed)
  avatar_url: string | null
  status: enum [available, busy, dnd, away, offline]
  status_message: string | null (max 280 chars)
  last_seen_at: timestamp
  created_at: timestamp
  updated_at: timestamp
}
```

### 2.2 Chat

A Chat is a conversation container. It can be 1:1 or group.

```
Chat {
  id: UUID (PK)
  type: enum [direct, group]
  title: string | null (max 256 chars, null for 1:1 chats)
  created_by: UUID (FK -> User.id)
  avatar_url: string | null (group chats only)
  is_pinned: boolean (default false, per-user via ChatMember)
  is_muted: boolean (default false, per-user via ChatMember)
  last_message_id: UUID | null (FK -> Message.id, denormalized)
  last_message_at: timestamp | null (denormalized)
  created_at: timestamp
  updated_at: timestamp
}
```

**Constraints:**
- `type=direct`: exactly 2 members, `title` is null (derived from other participant's name)
- `type=group`: 3-250 members, `title` is required
- A direct chat between the same two users is unique (enforce at application layer)

### 2.3 ChatMember

Join table for chat participants with per-user settings.

```
ChatMember {
  id: UUID (PK)
  chat_id: UUID (FK -> Chat.id, indexed)
  user_id: UUID (FK -> User.id, indexed)
  role: enum [owner, admin, member]
  is_muted: boolean (default false)
  is_pinned: boolean (default false)
  last_read_message_id: UUID | null (FK -> Message.id)
  last_read_at: timestamp | null
  joined_at: timestamp
  left_at: timestamp | null

  UNIQUE(chat_id, user_id)
}
```

**Constraints:**
- `role=owner`: only the creator initially; can transfer ownership
- `role=admin`: can add/remove members, change chat title/avatar
- `role=member`: can send messages, react, but cannot manage members
- `left_at != null` indicates the user has left the chat (soft-leave)

### 2.4 Message

```
Message {
  id: UUID (PK)
  chat_id: UUID (FK -> Chat.id, indexed)
  sender_id: UUID (FK -> User.id)
  content: string (max 28,000 chars, rich text as HTML or structured format)
  content_plain: string (plain text extraction for search indexing)
  type: enum [text, system, deleted]
  reply_to_id: UUID | null (FK -> Message.id, for threaded replies)
  is_edited: boolean (default false)
  edited_at: timestamp | null
  is_deleted: boolean (default false)
  deleted_at: timestamp | null
  metadata: json | null (link previews, special formatting data)
  created_at: timestamp (indexed)
  updated_at: timestamp
}
```

**Constraints:**
- `type=system`: generated by the system (e.g., "Alice added Bob to the chat"), `sender_id` may be null
- `type=deleted`: content replaced with empty string, original content purged
- `content` max length: 28,000 characters (same as Teams)
- Messages cannot be moved between chats

### 2.5 MessageMention

Tracks @mentions within a message.

```
MessageMention {
  id: UUID (PK)
  message_id: UUID (FK -> Message.id, indexed)
  mentioned_user_id: UUID (FK -> User.id, indexed)
  offset: int (character offset in content)
  length: int (character length of mention text)
}
```

### 2.6 MessageReaction

```
MessageReaction {
  id: UUID (PK)
  message_id: UUID (FK -> Message.id, indexed)
  user_id: UUID (FK -> User.id)
  emoji: string (unicode emoji or shortcode, max 32 chars)
  created_at: timestamp

  UNIQUE(message_id, user_id, emoji)
}
```

**Constraints:**
- One reaction per emoji per user per message (toggle on/off)
- Max 20 distinct emoji types per message

### 2.7 MessageAttachment

```
MessageAttachment {
  id: UUID (PK)
  message_id: UUID (FK -> Message.id, indexed)
  file_name: string (max 256 chars)
  file_size: bigint (bytes)
  mime_type: string (max 128 chars)
  storage_url: string (internal storage reference)
  thumbnail_url: string | null
  width: int | null (for images/videos)
  height: int | null (for images/videos)
  created_at: timestamp
}
```

**Constraints:**
- Max file size: 250 MB per attachment
- Max 10 attachments per message
- Allowed MIME types configured per deployment

### 2.8 LinkPreview

```
LinkPreview {
  id: UUID (PK)
  message_id: UUID (FK -> Message.id, indexed)
  url: string (max 2048 chars)
  title: string | null (max 256 chars)
  description: string | null (max 512 chars)
  image_url: string | null
  favicon_url: string | null
  domain: string (extracted from URL)
  fetched_at: timestamp
}
```

### 2.9 ReadReceipt

```
ReadReceipt {
  id: UUID (PK)
  chat_id: UUID (FK -> Chat.id, indexed)
  user_id: UUID (FK -> User.id, indexed)
  message_id: UUID (FK -> Message.id)
  read_at: timestamp

  UNIQUE(chat_id, user_id)
}
```

**Note:** Only the latest read position per user per chat is stored (watermark model). All messages with `created_at <= read_at` are considered read.

### 2.10 TypingIndicator (Ephemeral)

Not persisted. Transmitted via WebSocket/real-time channel only.

```
TypingIndicator {
  chat_id: UUID
  user_id: UUID
  is_typing: boolean
  timestamp: timestamp
}
```

### Entity Relationship Diagram

```
User 1──* ChatMember *──1 Chat
User 1──* Message *──1 Chat
User 1──* MessageReaction *──1 Message
User 1──* MessageMention *──1 Message
Message 1──* MessageAttachment
Message 1──* LinkPreview
Message 0..1──* Message (reply_to_id self-reference)
User 1──1 ReadReceipt ──1 Chat (per chat watermark)
```

---

## 3. API Endpoints

Base URL: `/api/v1`

All endpoints require authentication via `Authorization: Bearer <token>` header.

### 3.1 Chats

#### List Chats

```
GET /chats
```

Returns the authenticated user's chat list, sorted by last message timestamp (newest first).

**Query Parameters:**

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `limit` | int | 50 | Max results (1-100) |
| `cursor` | string | null | Pagination cursor (opaque, from previous response) |
| `filter` | enum | null | `unread`, `muted`, `pinned` |

**Response: 200 OK**
```json
{
  "chats": [
    {
      "id": "uuid",
      "type": "direct | group",
      "title": "string | null",
      "avatar_url": "string | null",
      "members": [
        {
          "user_id": "uuid",
          "display_name": "string",
          "avatar_url": "string | null",
          "role": "owner | admin | member"
        }
      ],
      "last_message": {
        "id": "uuid",
        "sender_id": "uuid",
        "sender_name": "string",
        "content_preview": "string (truncated to 120 chars)",
        "type": "text | system | deleted",
        "created_at": "ISO8601"
      },
      "unread_count": 3,
      "is_muted": false,
      "is_pinned": true,
      "updated_at": "ISO8601"
    }
  ],
  "next_cursor": "string | null"
}
```

#### Create Chat

```
POST /chats
```

**Request Body:**
```json
{
  "type": "direct | group",
  "member_ids": ["uuid", "uuid"],
  "title": "string (required for group, ignored for direct)"
}
```

**Response: 201 Created**
```json
{
  "id": "uuid",
  "type": "direct | group",
  "title": "string | null",
  "members": [...],
  "created_at": "ISO8601"
}
```

**Error Cases:**
- `409 Conflict`: Direct chat between same two users already exists (return existing chat)
- `400 Bad Request`: Group chat with fewer than 3 `member_ids`, or direct with != 2
- `400 Bad Request`: Group chat missing `title`

#### Get Chat Details

```
GET /chats/:chatId
```

**Response: 200 OK**
```json
{
  "id": "uuid",
  "type": "direct | group",
  "title": "string | null",
  "avatar_url": "string | null",
  "members": [
    {
      "user_id": "uuid",
      "display_name": "string",
      "avatar_url": "string | null",
      "role": "owner | admin | member",
      "joined_at": "ISO8601"
    }
  ],
  "created_by": "uuid",
  "is_muted": false,
  "is_pinned": false,
  "created_at": "ISO8601",
  "updated_at": "ISO8601"
}
```

#### Update Chat

```
PATCH /chats/:chatId
```

**Request Body (all fields optional):**
```json
{
  "title": "string",
  "avatar_url": "string"
}
```

**Authorization:** Requires `owner` or `admin` role.

**Response: 200 OK** (updated chat object)

#### Leave Chat

```
POST /chats/:chatId/leave
```

**Response: 204 No Content**

**Constraints:**
- Cannot leave a direct chat (use mute instead)
- If owner leaves a group chat, ownership transfers to the next admin, or the longest-tenured member

### 3.2 Chat Members

#### Add Members

```
POST /chats/:chatId/members
```

**Request Body:**
```json
{
  "user_ids": ["uuid", "uuid"]
}
```

**Authorization:** Requires `owner` or `admin` role. Group chats only.

**Response: 200 OK**
```json
{
  "added": ["uuid", "uuid"],
  "already_members": ["uuid"]
}
```

Generates a system message: "Alice added Bob and Carol to the chat."

#### Remove Member

```
DELETE /chats/:chatId/members/:userId
```

**Authorization:** Requires `owner` or `admin` role. Cannot remove the owner.

**Response: 204 No Content**

Generates a system message: "Alice removed Bob from the chat."

#### Update Member Settings (self)

```
PATCH /chats/:chatId/members/me
```

**Request Body:**
```json
{
  "is_muted": true,
  "is_pinned": false
}
```

**Response: 200 OK**

### 3.3 Messages

#### List Messages

```
GET /chats/:chatId/messages
```

Returns messages in reverse chronological order (newest first).

**Query Parameters:**

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `limit` | int | 50 | Max results (1-100) |
| `before` | UUID | null | Messages before this message ID |
| `after` | UUID | null | Messages after this message ID |
| `around` | UUID | null | Messages around this ID (limit/2 before, limit/2 after) |

**Response: 200 OK**
```json
{
  "messages": [
    {
      "id": "uuid",
      "chat_id": "uuid",
      "sender": {
        "id": "uuid",
        "display_name": "string",
        "avatar_url": "string | null"
      },
      "content": "string (rich text)",
      "content_plain": "string",
      "type": "text | system | deleted",
      "reply_to": {
        "id": "uuid",
        "sender_name": "string",
        "content_preview": "string (truncated to 100 chars)",
        "created_at": "ISO8601"
      } | null,
      "mentions": [
        {
          "user_id": "uuid",
          "display_name": "string",
          "offset": 0,
          "length": 5
        }
      ],
      "reactions": [
        {
          "emoji": "thumbsup",
          "count": 3,
          "users": ["uuid", "uuid", "uuid"],
          "me": true
        }
      ],
      "attachments": [
        {
          "id": "uuid",
          "file_name": "string",
          "file_size": 1024,
          "mime_type": "image/png",
          "url": "string",
          "thumbnail_url": "string | null",
          "width": 800,
          "height": 600
        }
      ],
      "link_previews": [
        {
          "url": "string",
          "title": "string",
          "description": "string",
          "image_url": "string | null",
          "favicon_url": "string | null",
          "domain": "example.com"
        }
      ],
      "is_edited": false,
      "edited_at": null,
      "created_at": "ISO8601"
    }
  ],
  "has_more": true
}
```

#### Send Message

```
POST /chats/:chatId/messages
```

**Request Body:**
```json
{
  "content": "string (rich text, max 28000 chars)",
  "reply_to_id": "uuid | null",
  "mentions": [
    {
      "user_id": "uuid",
      "offset": 10,
      "length": 5
    }
  ],
  "attachment_ids": ["uuid"]
}
```

**Response: 201 Created** (full message object as in List Messages)

**Side Effects:**
- Updates `Chat.last_message_id` and `Chat.last_message_at`
- Increments unread count for all other chat members
- Sends real-time event via WebSocket to all online members
- Sends push notification to offline/away members (unless muted)
- Triggers link preview extraction for URLs in content (async)

#### Edit Message

```
PATCH /chats/:chatId/messages/:messageId
```

**Request Body:**
```json
{
  "content": "string (updated rich text)"
}
```

**Authorization:** Only the original sender can edit.

**Constraints:**
- System messages cannot be edited
- Deleted messages cannot be edited
- No time limit on editing (differs from some implementations)

**Response: 200 OK** (updated message with `is_edited=true`, `edited_at` set)

#### Delete Message

```
DELETE /chats/:chatId/messages/:messageId
```

**Authorization:** Sender can delete own messages. Owner/admin can delete any message in the chat.

**Response: 204 No Content**

**Behavior:** Soft delete. Content is cleared, `type` set to `deleted`. The message placeholder remains in the timeline: "This message has been deleted."

#### React to Message

```
POST /chats/:chatId/messages/:messageId/reactions
```

**Request Body:**
```json
{
  "emoji": "thumbsup"
}
```

**Response: 201 Created** (or **204 No Content** if removing existing reaction -- toggle behavior)

**Behavior:** If the user already has this reaction on this message, remove it (toggle).

#### Remove Reaction

```
DELETE /chats/:chatId/messages/:messageId/reactions/:emoji
```

**Response: 204 No Content**

### 3.4 Read Receipts

#### Mark as Read

```
POST /chats/:chatId/read
```

**Request Body:**
```json
{
  "message_id": "uuid"
}
```

Updates the user's read watermark for this chat. All messages up to and including `message_id` are marked read.

**Response: 204 No Content**

**Side Effects:**
- Resets `unread_count` to count of messages after the watermark
- Broadcasts read receipt to other chat members via WebSocket

#### Get Read Receipts

```
GET /chats/:chatId/read-receipts
```

**Response: 200 OK**
```json
{
  "receipts": [
    {
      "user_id": "uuid",
      "display_name": "string",
      "last_read_message_id": "uuid",
      "read_at": "ISO8601"
    }
  ]
}
```

### 3.5 Typing Indicators

#### Send Typing Indicator

```
POST /chats/:chatId/typing
```

**Request Body:**
```json
{
  "is_typing": true
}
```

**Response: 204 No Content**

This is fire-and-forget. The server broadcasts to other chat members via WebSocket. Typing indicators auto-expire after 5 seconds of no refresh.

### 3.6 Attachments

#### Upload Attachment

```
POST /chats/:chatId/attachments
```

**Content-Type:** `multipart/form-data`

**Form Fields:**
- `file`: binary file data

**Response: 201 Created**
```json
{
  "id": "uuid",
  "file_name": "report.pdf",
  "file_size": 524288,
  "mime_type": "application/pdf",
  "url": "string",
  "thumbnail_url": "string | null"
}
```

Uploaded attachments are associated with the chat but not yet attached to a message. The returned `id` should be included in `attachment_ids` when sending a message. Orphaned attachments (not referenced by any message within 24 hours) are garbage collected.

#### Download Attachment

```
GET /chats/:chatId/attachments/:attachmentId/download
```

**Response: 302 Found** (redirect to signed download URL)

### 3.7 Search

#### Search Messages

```
GET /chats/search
```

**Query Parameters:**

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `q` | string | required | Search query (full-text) |
| `chat_id` | UUID | null | Restrict to specific chat |
| `from` | UUID | null | Filter by sender |
| `after` | ISO8601 | null | Messages after this date |
| `before` | ISO8601 | null | Messages before this date |
| `has` | enum | null | `attachment`, `link`, `mention` |
| `limit` | int | 20 | Max results (1-50) |
| `cursor` | string | null | Pagination cursor |

**Response: 200 OK**
```json
{
  "results": [
    {
      "message": { ... },
      "chat": {
        "id": "uuid",
        "title": "string",
        "type": "direct | group"
      },
      "highlights": ["matched <mark>term</mark> in context"]
    }
  ],
  "total_count": 42,
  "next_cursor": "string | null"
}
```

---

## 4. UI Components

### 4.1 Chat List (Left Sidebar)

**Component:** `ChatList`

| Element | Description |
|---------|-------------|
| Chat list header | "Chat" title, new chat button, filter/search |
| Chat list item | Avatar(s), title/names, last message preview, timestamp, unread badge |
| Unread badge | Numeric count (e.g., "3") on chat items with unread messages |
| Pinned section | Pinned chats appear at top, separated by divider |
| Empty state | "No chats yet" with "Start a chat" CTA |

**Chat List Item Layout:**
```
[Avatar(s)] [Title / Participant Names]    [Timestamp]
             [Last message preview...]     [Unread Badge]
```

**Behavior:**
- Clicking a chat item opens the chat in the main content area
- Right-click context menu: Pin, Mute, Mark as read, Leave, Hide
- Unread chats have bold title text
- Timestamp shows relative time (e.g., "2m", "1h", "Yesterday", "Mon", "Jan 15")
- Last message preview truncated to ~60 chars, prefixed with sender name for group chats

### 4.2 Chat View (Main Content)

**Component:** `ChatView`

| Element | Description |
|---------|-------------|
| Chat header | Title/names, avatar(s), member count, call/video buttons, more menu |
| Chat tabs | Chat, Shared, Recap, Q&A |
| Message list | Scrollable list of messages, grouped by date |
| New messages indicator | "New messages" banner when scrolled up and new messages arrive |
| Compose bar | Message input area at bottom |

### 4.3 Message Bubble

**Component:** `MessageBubble`

| Element | Description |
|---------|-------------|
| Sender avatar | Shown for first message in a consecutive group from same sender |
| Sender name | Shown in group chats, colored per-user |
| Message content | Rich text rendered HTML |
| Quoted reply | Indented block showing original message snippet if replying |
| Link preview card | Card with title, description, thumbnail, domain |
| Attachments | Inline images, file cards for documents |
| Reactions bar | Row of emoji buttons with counts below message |
| Timestamp | Shown on hover or for first/last message in a time group |
| "Edited" label | Small text next to timestamp if message was edited |
| Hover actions | Reply, React, More (edit, delete, forward, pin) |

**Message Grouping Rules:**
- Messages from the same sender within 2 minutes are visually grouped (no repeated avatar/name)
- Date separators inserted between different calendar days ("Today", "Yesterday", "Monday, January 15")
- "New messages" separator shown at the boundary of unread messages on initial load

### 4.4 Compose Bar

**Component:** `ComposeBar`

| Element | Description |
|---------|-------------|
| Text input | Multi-line, auto-expanding textarea with placeholder "Type a message" |
| Formatting toolbar | Bold, Italic, Underline, Strikethrough, Code, Bulleted list, Numbered list, Quote, Heading |
| Emoji button | Opens emoji picker popover |
| Attachment button | Opens file picker dialog |
| Apps button | Opens apps/integrations panel |
| Send button | Sends the message (or Enter key) |
| Reply preview | When replying, shows quoted message above input with dismiss button |

**Keyboard Shortcuts:**

| Shortcut | Action |
|----------|--------|
| `Enter` | Send message |
| `Shift+Enter` | New line |
| `Ctrl+B` | Bold |
| `Ctrl+I` | Italic |
| `Ctrl+U` | Underline |
| `Ctrl+Shift+X` | Strikethrough |
| `Ctrl+E` | Inline code |
| `@` | Trigger mention autocomplete |
| `Escape` | Cancel reply / clear formatting |

### 4.5 Mention Autocomplete

**Component:** `MentionAutocomplete`

Triggered when user types `@` in the compose bar. Shows a dropdown of matching users.

| Element | Description |
|---------|-------------|
| User list | Avatar, display name, email. Filtered as user types |
| Keyboard navigation | Arrow keys to select, Enter to insert |
| "Everyone" option | @all / @everyone mention for group chats |

### 4.6 Emoji Picker

**Component:** `EmojiPicker`

| Element | Description |
|---------|-------------|
| Search bar | Filter emojis by name |
| Category tabs | Smileys, People, Animals, Food, Activities, Travel, Objects, Symbols, Flags |
| Recently used | Top section showing user's frequent emojis |
| Skin tone selector | Modifier for applicable emojis |

### 4.7 Chat Tabs

| Tab | Content |
|-----|---------|
| **Chat** | Default message view |
| **Shared** | Files, links, and media shared in this chat (gallery/list view) |
| **Recap** | AI-generated summary of recent conversation (if enabled) |
| **Q&A** | Pinned questions and answers from the chat |

---

## 5. Business Rules & Constraints

### 5.1 Chat Rules

| Rule | Constraint |
|------|------------|
| Direct chat uniqueness | Only one direct chat can exist between any two users |
| Group chat size | Min 3, max 250 members |
| Group chat title | Required, 1-256 characters |
| Chat creation | Any authenticated user can create a chat |
| Member management | Only owner/admin can add/remove members in group chats |
| Ownership transfer | Automatic on owner leave: next admin, or longest-tenured member |
| Muting | Muted chats don't generate notifications but still track unread count |
| Pinning | Max 15 pinned chats per user |

### 5.2 Message Rules

| Rule | Constraint |
|------|------------|
| Max content length | 28,000 characters |
| Edit permission | Only original sender |
| Edit time limit | None (can edit anytime) |
| Delete permission | Sender (own messages), owner/admin (any message in chat) |
| Delete behavior | Soft delete; placeholder shown in timeline |
| Max attachments per message | 10 |
| Max attachment size | 250 MB |
| Max reactions per message | 20 distinct emoji types |
| Reaction behavior | Toggle: add if not present, remove if already exists |
| Mentions | Only members of the chat can be @mentioned |
| Reply depth | Flat replies only (reply-to always references a top-level message, no nested threads) |
| System messages | Cannot be edited, deleted, or reacted to |

### 5.3 Rate Limits

| Action | Limit |
|--------|-------|
| Send message | 30 per minute per user per chat |
| Edit message | 10 per minute per user |
| Reactions | 60 per minute per user |
| Typing indicator | 1 per 3 seconds per user per chat |
| File upload | 10 per minute per user |
| Search | 10 per minute per user |

### 5.4 Notifications

| Event | Notification Type |
|-------|------------------|
| New message in unmuted chat | Push + badge |
| @mention | Push + badge (even if muted) |
| Reaction to own message | In-app only |
| Added to chat | Push + badge |
| Removed from chat | In-app only |
| Message edited (quoted reply) | None |

### 5.5 Read Receipt Rules

- Read receipts use a watermark model: storing only the latest read message per user per chat
- Opening a chat auto-marks visible messages as read
- Scrolling to bottom marks all messages as read
- Unread count = count of messages after the user's read watermark
- Read receipt updates are batched and debounced (200ms) to avoid excessive writes

### 5.6 Message Ordering

- Messages are ordered by `created_at` timestamp (server-assigned)
- Server assigns timestamp on receipt to avoid clock skew issues
- In case of exact timestamp collision, secondary sort by `id` (UUID v7, time-ordered)

---

## 6. Edge Cases

### 6.1 Concurrent Editing

**Scenario:** User A and User B both edit the same message (if both are sender, e.g., in a race condition).

**Resolution:** Last-write-wins. The `updated_at` timestamp reflects the last edit. No conflict resolution needed since only the original sender can edit.

### 6.2 Deleted Reply Target

**Scenario:** A message is a reply to another message, and the replied-to message gets deleted.

**Resolution:** The reply remains. The quoted section shows "This message has been deleted" with the original sender name preserved.

### 6.3 Member Removed While Composing

**Scenario:** User is typing a message, but gets removed from the chat before sending.

**Resolution:** The send API returns `403 Forbidden`. Client shows an error: "You are no longer a member of this chat." Unsent message content is preserved in a local draft.

### 6.4 Large Group Chat Loading

**Scenario:** A group chat has 250 members and thousands of messages.

**Resolution:**
- Member list is paginated (first 20 shown, "and 230 more" with lazy load)
- Messages loaded in pages of 50, scrolling up triggers loading older messages
- Reactions show first 3 users + "+N more" tooltip

### 6.5 Duplicate Direct Chat Prevention

**Scenario:** Two users simultaneously try to create a direct chat with each other.

**Resolution:** Database unique constraint on ordered user pair `(min(user_a, user_b), max(user_a, user_b))`. Second request gets `409 Conflict` with the existing chat returned.

### 6.6 Message with Only Attachments

**Scenario:** User sends a message with attachments but no text content.

**Resolution:** Allowed. `content` can be an empty string if `attachment_ids` is non-empty. The message displays as attachment-only (image grid or file cards).

### 6.7 Offline Message Queue

**Scenario:** User sends a message while temporarily offline.

**Resolution:** Client queues the message locally with a pending state (grayed out, clock icon). On reconnection, messages are sent in order. If send fails permanently (e.g., removed from chat), client shows error inline.

### 6.8 Link Preview Failures

**Scenario:** A URL in a message fails to generate a preview (timeout, 404, no OpenGraph tags).

**Resolution:** No preview card shown. The URL remains as a clickable hyperlink in the message. Preview generation is async and best-effort; it does not block message delivery.

### 6.9 Mention of Removed Member

**Scenario:** A message contains an @mention of a user who is later removed from the chat.

**Resolution:** The mention text remains rendered but becomes non-interactive (no click-to-profile). The mentioned user stops receiving notifications from this chat.

### 6.10 Rapid Message Sending

**Scenario:** User sends messages faster than the rate limit (30/min).

**Resolution:** Server returns `429 Too Many Requests` with a `Retry-After` header. Client disables the send button temporarily and shows "Slow down - you're sending messages too quickly."

### 6.11 Empty Chat State

**Scenario:** A new group chat is created but no messages have been sent yet.

**Resolution:** Show a welcome state: "This is the start of your conversation with [members]. Say hello!" with the chat creation system message ("Alice created this chat and added Bob, Carol").

### 6.12 Very Long Messages

**Scenario:** A message approaches the 28,000 character limit.

**Resolution:** Client shows a character counter when content exceeds 25,000 chars. The compose bar shows remaining characters. At 28,000, input is blocked and send is disabled until content is shortened.

### 6.13 Chat with Self

**Scenario:** User tries to create a direct chat with themselves.

**Resolution:** Allowed. This creates a "Notes to Self" chat that functions as a personal scratchpad. Only one self-chat per user.

### 6.14 Concurrent Read Receipt Updates

**Scenario:** Multiple tabs/devices send read receipts for the same chat simultaneously.

**Resolution:** Read watermark only advances forward. If the incoming `message_id` has a `created_at` earlier than the current watermark, the update is ignored (no regression).

---

## Appendix A: Rich Text Format

Messages use a subset of HTML for rich text content:

**Allowed Tags:**
- `<b>`, `<i>`, `<u>`, `<s>` (formatting)
- `<code>`, `<pre>` (code)
- `<a href="...">` (links)
- `<ul>`, `<ol>`, `<li>` (lists)
- `<blockquote>` (quotes)
- `<h1>` through `<h3>` (headings)
- `<br>` (line breaks)
- `<p>` (paragraphs)
- `<span data-mention-id="uuid">` (mentions)
- `<img>` (inline images from attachments only, src must be internal URL)

All other HTML tags are stripped on the server side. All attribute values are sanitized to prevent XSS.

## Appendix B: WebSocket Events

Real-time events are delivered over a WebSocket connection at `/ws`.

| Event | Payload | Recipients |
|-------|---------|------------|
| `message.created` | Full message object | All online chat members |
| `message.updated` | Updated message object | All online chat members |
| `message.deleted` | `{ message_id, chat_id }` | All online chat members |
| `reaction.added` | `{ message_id, emoji, user_id, count }` | All online chat members |
| `reaction.removed` | `{ message_id, emoji, user_id, count }` | All online chat members |
| `typing.started` | `{ chat_id, user_id, display_name }` | All online chat members except sender |
| `typing.stopped` | `{ chat_id, user_id }` | All online chat members except sender |
| `read_receipt.updated` | `{ chat_id, user_id, message_id }` | All online chat members |
| `member.added` | `{ chat_id, user_id, added_by }` | All online chat members |
| `member.removed` | `{ chat_id, user_id, removed_by }` | All online chat members + removed user |
| `chat.updated` | `{ chat_id, title?, avatar_url? }` | All online chat members |
